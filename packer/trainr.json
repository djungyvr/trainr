{
	"variables": {
		"access_key": "",
		"secret_key": ""
	},
	"sensitive-variables": ["access_key", "secret_key"],
	"builders": [
		{
			"access_key": "{{user `access_key`}}",
			"secret_key": "{{user `secret_key`}}",
			"ami_name": "packer-linux-aws-trainr-{{timestamp}}",
			"instance_type": "t2.medium",
			"region": "us-west-2",
			"source_ami_filter": {
			  "filters": {
			  "virtualization-type": "hvm",
			  "name": "ubuntu/images/*ubuntu-xenial-16.04-amd64-server-*",
			  "root-device-type": "ebs"
			  },
			  "owners": ["099720109477"],
			  "most_recent": true
			},
			"ssh_username": "ubuntu",
			"type": "amazon-ebs"
		}
	],
	"provisioners": [
		{
			"type": "shell",
			"inline": [
				"sleep 30",
				"sudo apt update",
				"sudo apt -y upgrade",
				"sudo apt-key adv --fetch-keys http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/7fa2af80.pub",
				"wget http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_9.1.85-1_amd64.deb",
				"sudo apt install ./cuda-repo-ubuntu1604_9.1.85-1_amd64.deb",
				"wget http://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1604/x86_64/nvidia-machine-learning-repo-ubuntu1604_1.0.0-1_amd64.deb",
				"sudo apt install ./nvidia-machine-learning-repo-ubuntu1604_1.0.0-1_amd64.deb",
				"sudo apt update",
				"sudo apt install cuda9.0 cuda-cublas-9-0 cuda-cufft-9-0 cuda-curand-9-0 cuda-cusolver-9-0 cuda-cusparse-9-0 libcudnn7=7.2.1.38-1+cuda9.0 libnccl2=2.2.13-1+cuda9.0 cuda-command-line-tools-9-0",
				"sudo apt install -y python3-pip",
				"pip3 install --upgrade pip",
				"pip3 install tensorflow-gpu",
				"pip3 install keras"
			]
		}
	]
}
